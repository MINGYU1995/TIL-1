# Singleton

&nbsp; Application Context는 싱글톤을 저장하고 관리하는 Singleton Registry이다. 스프링은 기본적으로 내부에서 생성하는 빈 오브젝트를 모두 싱글톤으로 만든다. 여기서 싱글톤이라는 것은 디자인 패턴에서 나오는 싱글톤 패턴과 비슷한 개념이지만 그 구현방법은 확실한 차이가 있다.

<br>

## **싱글톤 패턴**
&nbsp; 싱글톤 패턴은 GoF가 소개한 디자인 패턴 중 하나이다. 디자인 패턴 중에서 가장 자주 활용되는 패턴이기도 하지만 매우 조심해서 사용해야 한다. 싱글톤 패턴은 어떤 클래스를 애플리케이션 내에서 하나의 인스턴스만 존재하도록 강제하는 패턴이다. **단일 오브젝트**로 존재하며 애플리케이션 내에서 **전역적으로 접근**이 가능하다.

<br>

## **싱글톤 패턴 구현**

```java
public class UserDao{
    private static UserDao INSTANCE;

    // 클래스 밖에서 오브젝트를 생성하지 못하도록
    // 생성자를 private로
    private UserDao(){
    }

    // 한번 오브젝트가 만들어지고 나서는 이미 만들어져있는 오브젝트 반환
    public static synchronized UserDao getInstance(){
        if(INSTANCE == null)
            INSTANCE = new UserDao();
        return INSTANCE;
    }
}

```

<details>
<summary>정적 멤버 변수와 함수</summary>

* 정적 멤버 변수
 : 객체 별로 할당되지 않고 클래스의 모든 객체가 공유하는 멤버

* 정적 멤버 함수
 : 해당 클래스의 객체를 생성하지 않고도, 클래스 이름만으로 호출가능
</details>

<details>
<summary>synchronized</summary>

: multi-thread환경에서 동기화를 제어해준다.   
즉, 해당 객체에 lock을 걸어 멀티스레드로 동시 접근되는 것을 막아준다.
</details>

<br>

## **싱글톤 패턴 한계**

1. **상속 불가**   
 : private 생성자를 갖고 있어 상속이 불가능하다. **객체 지향적인 설계의 장점을 적용하기 어렵다**는 문제를 가지고 있다. 또한 객체지향의 특징이 적용되지 않는 static 필드와 함수를 사용하는 것도 역시 동일한 문제를 발생시킨다.

2. **테스트의 어려움**   
 : 싱글톤은 테스트하기가 어렵거나 아예 불가능할 수도 있다. 싱글톤은 만들어지는 방식이 제한적이기 때문에 테스트에서 사용될 때 목 오브젝트 등으로 대체하기가 힘들다. 테스트는 엔터프라이즈 개발의 핵심인데 애플리케이션 코드를 싱글톤으로 만들면 테스트에 지장이 있다는 것은 큰 문제점이다.

3. 서버 환경에서는 싱글톤 보장 불가   
 : 서버에서 클래스 로더를 어떻게 구성하고 있느냐에 따라서 싱글톤 클래스임에도 하나 이상의 오브젝트가 만들어질 수 있다.

4. 싱글톤의 사용은 전역 상태를 만들 수 있다.   
 : 싱글톤의 static 메소드를 이용해 언제든지 싱글톤에 쉽게 접근할 수 있기 때문에 애플리케이션 어디서든지 사용될 수 있고 그러다 보면 자연스럽게 전역상태(global state)로 사용되기 쉽다. 아무 객체나 자유롭게 접근하고 수정하고 공유할 수 있는 전역 상태를 가지는 것은 객체 지향 프로그래밍에서는 권장되지않는 모델이다. 그럼에도 싱글톤을 사용하면 그런 상태에 빠지기 쉽다.

<br>

## **싱글톤 레지스트리**

&nbsp; 그렇다면 왜 스프링은 bean을 싱글톤으로 만드는 것일까? 매번 클라이언트에서 요청이 올 때마다 각 로직을 담당하는 오브젝트를 새로 만들어서 사용하게 되면 서버가 감당하기 힘들다. 때문에 엔터프라이즈 분야에서는 **서비스 오브젝트**라는 개념을 일찍부터 사용해왔다.   
&nbsp; 서블릿은 자바 엔터프라이즈 기술의 가장 기본이 되는 서비스 오브젝트라고 할 수 있다. 서블릿은 보통 **멀티스레드 환경에서 싱글톤으로 동작**한다. 서블릿 클래스당 하나의 오브젝트만 만들어두고 사용자의 요청을 담당하는 여러 스레드에서 하나의 오브젝트를 공유해 동시에 사용한다.

&nbsp; 스프링은 서버환경에서 싱글톤이 만들어져서 서비스 오브젝트 방식으로 사용되는 것은 적극 지지한다. 하지만 자바의 기본적인 싱글톤 패턴의 구현방식은 여러가지 단점이 있기에 스프링은 **직접 싱글톤 형태의 오브젝트를 만들고 관리**하는 기능을 제공한다. 그것이 바로 **Singleton Registry**이다. 때문에 스프링 컨테이너는 싱글톤을 생성, 관리, 공급하는 싱글톤 관리 컨테이너이기도하다.

<br>

## **싱글톤 레지스트리 장점**

1. **평범한 자바 클래스를 싱글톤으로 활용**   
 : static 메소드와 private 생성자를 사용하지않고 평범한 자바클래스를 싱글톤으로 활용하게 해준다. 평범한 자바클래스라도 IoC방식의 컨테이너를 사용해서 생성과 관계설정, 사용등에 대한 제어권을 컨테이너에게 넘기면 손쉽게 싱글톤 방식으로 만들어져 관리되게 할 수 있다. 오브젝트 생성에 관한 모든 권한은 IoC 기능을 제공하는 애플리케이션 컨텍스트에 있기 때문이다.

2. **간편한 테스트**   
 : public 생성자를 가질 수 있기 때문에 테스트 환경에서 자유롭게 오브젝트를 만들 수 있다. 테스트를 위한 목 오브젝트로 대체하는 것도 간단하다.

3. **객체 지향적인 설계방식과 원칙을 위배하지 않는다.**


<br>

## **빈의 스코프**

&nbsp; 빈의 Scope란 빈이 생성되고, 존재하고, 적용되는 범위를 말한다. 스프링 빈의 기본 스코프는 싱글톤이다. **싱글톤 스코프**는 컨테이너 내에 **한 개의 오브젝트만** 만들어져서 강제로 제거하지 않는 한 스프링 컨테이너가 존재하는 동안 **계속 유지**된다.   
&nbsp; 경우에 따라서는 빈이 싱글톤 외의 스코프를 가질 수 있다. 대표적으로 prototype 스코프가 있다. 프로토타입은 싱글톤과 달리 컨테이너에 빈을 요청할대마다 매번 새로운 오브젝트를 만들어준다.
이외에도 새로운 HTTP 요청이 생길 때마다 생성되는 request scope와 웹의 세션과 스코프가 유사한 session scope가 있다.

<br>

출처 :    
토비의 스프링 3.1 vol.1 (이일민 저)

